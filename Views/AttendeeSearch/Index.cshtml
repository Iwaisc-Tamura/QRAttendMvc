@model IEnumerable<QRAttendMvc.Models.AttendeeSearchRow>
@using QRAttendMvc.Models

@{
    Layout = null; // ★① _Layout の影響を受けない
    ViewData["Title"] = "入退場照会";

    string currentKaisaiCd = ViewBag.CurrentKaisaiCd as string ?? "";

    string companyKana = ViewBag.CompanyKana as string ?? "";
    string companyName = ViewBag.CompanyName as string ?? "";
    string workerKanaLast = ViewBag.WorkerKanaLast as string ?? "";
    string workerKanaFirst = ViewBag.WorkerKanaFirst as string ?? "";
    string workerId = ViewBag.WorkerId as string ?? "";
    string birthDate = ViewBag.BirthDate as string ?? "";
    bool includeLower = ViewBag.IncludeLower is bool b && b;

    // ログイン表示（既存の値の取り方に合わせてください）
    var login = "XXXXXX-yyyyy";
}

<!doctype html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>

    <!-- 単独表示なので自前でCSSを読む -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>

<body class="index-attende">
    <!-- ===== ヘッダー（master風） ===== -->
    <header class="as-header">
        <div class="as-tab">検索</div>
        <div class="as-title">入退場照会</div>
    </header>

    <main class="as-container">

        <!-- ★② 日付・時刻：指定の ev-loginbox を使用 -->
        <div class="ev-loginbox" aria-label="ログイン情報">
            <div class="ev-login-row">
                <span class="ev-login-label">ログイン</span>
                <span class="ev-login-value">@login</span>
            </div>
            <div class="ev-login-row">
                <div class="ev-login-label">日付</div>
                <div class="ev-login-value">
                    <span id="eventDate"></span>
                </div>
            </div>

            <div class="ev-login-row">
                <div class="ev-login-label">時刻</div>
                <div class="ev-login-value">
                    <span id="eventTime"></span>
                </div>
            </div>
        </div>

        <!-- 開催コード（既存項目名は変更しない③） -->
        @if (!string.IsNullOrEmpty(currentKaisaiCd))
        {
            <section class="as-eventinfo">
                <div class="as-info-row">
                    <div class="as-info-label">開催コード</div>
                    <div class="as-info-value">@currentKaisaiCd</div>
                </div>
            </section>
        }

        <!-- ===== 検索条件 ===== -->
        <form method="get" class="as-form">
            <!-- 1段目：会社名（カナ）／会社名／2次店以下含む／検索 -->
            <div class="as-grid as-grid-1">
                <div class="as-field">
                    <label class="as-label">会社名（カナ）</label>
                    <input name="companyKana" value="@companyKana" class="as-input" />
                </div>

                <div class="as-field">
                    <label class="as-label">会社名</label>
                    <input name="companyName" value="@companyName" class="as-input" />
                </div>

                <div class="as-field as-check">
                    <label class="as-checkline">
                        <input type="checkbox" name="includeLower" value="true" @(includeLower ? "checked" : "") />
                        <span>2次店以下含む</span>
                    </label>
                </div>

                <div class="as-field as-action">
                    <button type="submit" class="as-btn as-btn-search">検索</button>
                </div>
            </div>

            <!-- 2段目：作業員名（カナ）姓／名／作業員ID／生年月日 -->
            <div class="as-grid as-grid-2">
                <div class="as-field">
                    <label class="as-label">作業員名（カナ） 姓</label>
                    <input name="workerKanaLast" value="@workerKanaLast" class="as-input" />
                </div>

                <div class="as-field">
                    <label class="as-label">名</label>
                    <input name="workerKanaFirst" value="@workerKanaFirst" class="as-input" />
                </div>

                <div class="as-field">
                    <label class="as-label">作業員ID</label>
                    <input name="workerId" value="@workerId" class="as-input" />
                </div>

                <div class="as-field">
                    <label class="as-label">生年月日</label>
                    <!-- type=dateはそのまま。masterに合わせて見た目はCSSで寄せる -->
                    <input name="birthDate" type="date" value="@birthDate" class="as-input" />
                </div>
            </div>
        </form>

        <!-- ===== 一覧 ===== -->
        <section class="as-tablewrap">
            <table class="as-table">
                <thead>
                    <tr>
                        <th>会社名</th>
                        <th>作業員ID</th>
                        <th>作業員名</th>
                        <th>生年月日</th>
                        <th>名簿対象除外日</th>
                        <th>入場記録</th>
                        <th>退場記録</th>
                        <th>名簿</th>
                        <th>作業員</th>
                        <th>代表他</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var r in Model)
                    {
                        <tr>
                            <td>@r.CompanyName</td>
                            <td>@r.WorkerId</td>
                            <td>@r.WorkerName</td>

                            <!-- 追加 2026.02.14 Takada -->
                            <td>@(r.BirthDate?.ToString("yyyy/M/d") ?? "")</td>
                            <td>@(r.ExcludeDate?.ToString("yyyy/M/d") ?? "")</td>

                            <td>@(r.LastInTime?.ToString("HH:mm"))</td>
                            <td>@(r.LastOutTime?.ToString("HH:mm"))</td>

                            <td class="as-center">
                                <input type="radio" name="role_@r.WorkerId" @(r.RoleType == "名簿" ? "checked" : "") />
                            </td>
                            <td class="as-center">
                                <input type="radio" name="role_@r.WorkerId" @(r.RoleType == "作業員" ? "checked" : "") />
                            </td>
                            <td class="as-center">
                                <input type="radio" name="role_@r.WorkerId" @(r.RoleType == "代表他" ? "checked" : "") />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </section>

        <!-- ===== 操作ボタン ===== -->
        <section class="as-footer">
            <a asp-action="Export"
               asp-route-companyKana="@companyKana"
               asp-route-companyName="@companyName"
               asp-route-workerKanaLast="@workerKanaLast"
               asp-route-workerKanaFirst="@workerKanaFirst"
               asp-route-workerId="@workerId"
               asp-route-birthDate="@birthDate"
               asp-route-includeLower="@includeLower"
               class="as-btn as-btn-primary">
                CSV出力（タブ区切り）
            </a>

            <a asp-controller="Home" asp-action="Index" class="as-btn as-btn-secondary">
                メインメニューに戻る
            </a>
        </section>
    </main>

    <!-- ★② 指定スクリプト（そのまま） -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const stored = sessionStorage.getItem("fixedLayoutTime");
            if (!stored) return;

            const fixedDate = new Date(stored);
            const week = ["(日)", "(月)", "(火)", "(水)", "(木)", "(金)", "(土)"];
            const w = week[fixedDate.getDay()];

            // layoutClock と同じフォーマット
            const dateText =
                fixedDate.getFullYear() + "/" +
                (fixedDate.getMonth() + 1) + "/" +
                fixedDate.getDate() + "/" + " " + w;

            // layoutTime　と同じフォーマット
            const timeText =
                fixedDate.getHours().toString().padStart(2, '0') + "：" +
                fixedDate.getMinutes().toString().padStart(2, '0') + "：" +
                fixedDate.getSeconds().toString().padStart(2, '0');

            document.getElementById("eventDate").textContent = dateText;
            document.getElementById("eventTime").textContent = timeText;
        });
    </script>
</body>
</html>