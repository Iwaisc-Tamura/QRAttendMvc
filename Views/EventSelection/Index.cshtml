@using System.Text.Json
@{
    Layout = null;
    ViewData["Title"] = "イベント選択画面";

    bool autoSelected = ViewBag.AutoSelected != null && (bool)ViewBag.AutoSelected;

    // 複数候補用
    string preloadedJson = "[]";
    try
    {
        preloadedJson = JsonSerializer.Serialize(
            ViewBag.PreloadedEvents ?? Array.Empty<object>(),
            new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }
        );
    }
    catch { }

    // 1件確定用
    string selectedJson = "{}";
    try
    {
        selectedJson = JsonSerializer.Serialize(
            ViewBag.Selected ?? new { },
            new JsonSerializerOptions { PropertyNamingPolicy = JsonNamingPolicy.CamelCase }
        );
    }
    catch { }

    var b = Context?.Session?.GetString("BRANCH_CD") ?? "";
    var e = Context?.Session?.GetString("EMPLOYEE_CD") ?? "";
    var login = (!string.IsNullOrEmpty(b) && !string.IsNullOrEmpty(e))
        ? $"{b}-{e}"
        : (ViewBag.LoginText ?? "XXXXX-YYYYY");
}

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - 協力会社入退場記録システム</title>

    <link rel="stylesheet" href="~/css/site.css" />
</head>

<body class="event-page">

    <div class="ev-header">
        <div class="ev-tab">イベント</div>
        <div class="ev-title">イベント選択画面</div>
    </div>

    <div class="ev-container">

        @if (TempData["Error"] != null)
        {
            <div class="ev-alert ev-alert-danger">@TempData["Error"]</div>
        }
        @if (ViewData["BusinessMessage"] != null)
        {
            <div class="ev-alert ev-alert-warn">@Html.Raw(ViewData["BusinessMessage"].ToString()!.Replace("\n", "<br />"))</div>
        }

        <div class="ev-form">

            <!-- 区分 + 右側にログイン/日付/時刻（※2重表示になる loginOnlyArea は削除） -->
            <div class="ev-row ev-row-3" id="divisionArea">
                <div class="ev-label">区分</div>

                <!-- ★ 枠は select だけに統一（上段の "-" 枠を廃止） -->
                <div class="ev-field ev-field-mid">
                    <select id="divisionSelect" class="ev-select">
                        <option value="">選択してください</option>
                    </select>
                </div>

                <div class="ev-loginbox" aria-label="ログイン情報">
                    <div class="ev-login-row">
                        <span class="ev-login-label">ログイン</span>
                        <span class="ev-login-value">@login</span>
                    </div>
                    <div class="ev-login-row">
                        <span class="ev-login-label">日付</span>
                        <span class="ev-login-value" id="dispDate">@DateTime.Now.ToString("yyyy/MM/dd")</span>
                    </div>
                    <div class="ev-login-row">
                        <span class="ev-login-label">時刻</span>
                        <span class="ev-login-value" id="clock">@DateTime.Now.ToString("HH:mm")</span>
                    </div>
                </div>
            </div>

            <!-- 開催拠点 -->
            <div class="ev-row">
                <div class="ev-label">開催拠点</div>
                <div class="ev-field">
                    <div class="ev-selectlike ev-readonly" id="branchDisplay"></div>
                </div>
            </div>

            <!-- 受講場所 -->
            <div class="ev-row">
                <div class="ev-label">受講場所</div>
                <div class="ev-field">
                    <div class="ev-underline" id="evLoc"></div>
                </div>
            </div>

            <!-- イベント開催日 / 年度 -->
            <div class="ev-row ev-row-split">
                <div class="ev-split-left">
                    <div class="ev-label">イベント開催日</div>
                    <div class="ev-field">
                        <div class="ev-underline" id="dateDisplay">@DateTime.Today.ToString("yyyy/MM/dd")</div>
                    </div>
                </div>

                <div class="ev-split-right">
                    <div class="ev-inline">
                        <span class="ev-label-inline">年度</span>
                        <span class="ev-yearbox" id="evYear"></span>
                        <span class="ev-label-inline">年度</span>
                    </div>
                </div>
            </div>

            <!-- 開始時刻 -->
            <div class="ev-row" id="startArea">
                <div class="ev-label">開始時刻</div>

                <!-- ★ 枠は select だけに統一（上段の "-" 枠を廃止） -->
                <div class="ev-field ev-field-short">
                    <select id="startSelect" class="ev-select">
                        <option value="">選択してください</option>
                    </select>
                </div>
            </div>

            <!-- 終了時刻 -->
            <div class="ev-row">
                <div class="ev-label">終了時刻</div>
                <div class="ev-field ev-field-short">
                    <div class="ev-underline" id="evEnd"></div>
                </div>
            </div>

            <!-- 受付開始時刻 -->
            <div class="ev-row">
                <div class="ev-label">受付開始時刻</div>
                <div class="ev-field ev-field-short">
                    <div class="ev-underline" id="evRecept"></div>
                </div>
            </div>

            <!-- イベント情報 -->
            <div class="ev-info">
                <div class="ev-info-title">イベント情報</div>
                <div class="ev-info-row">EventCode：<span id="evCode"></span></div>
                <div class="ev-info-row">イベント名：<span id="evName"></span></div>
                <div class="ev-info-row">開始時刻：<span id="evStart"></span></div>
            </div>
        </div>

        <!-- 下部ボタン -->
        <div class="ev-actions">
            <form asp-action="GoToBatch" method="post">
                <input type="hidden" name="mode" value="IN" />
                <button type="submit" id="btnBatchIn" class="ev-btn ev-btn-blue" disabled>
                    入退場登録<br />（一括入場）
                </button>
            </form>

            <form asp-action="GoToTemp" method="post">
                <input type="hidden" name="kind" value="IN" />
                <button type="submit" id="btnTempIn" class="ev-btn ev-btn-blue2" disabled>
                    入退場登録<br />（入場）
                </button>
            </form>

            <form asp-action="GoToBatch" method="post">
                <input type="hidden" name="mode" value="OUT" />
                <button type="submit" id="btnBatchOut" class="ev-btn ev-btn-orange" disabled>
                    入退場登録<br />（一括退場）
                </button>
            </form>

            <form asp-action="GoToTemp" method="post">
                <input type="hidden" name="kind" value="OUT" />
                <button type="submit" id="btnTempOut" class="ev-btn ev-btn-orange2" disabled>
                    入退場登録<br />（退場）
                </button>
            </form>

            <form asp-controller="AttendeeSearch" asp-action="Index" method="get">
                <button type="submit" id="btnAttendeeSearch" class="ev-btn ev-btn-green">
                    受講者<br />検索
                </button>
            </form>

            <a asp-controller="Home" asp-action="Index" class="ev-btn ev-btn-sky ev-btn-link">
                メインメニューに<br />戻る
            </a>
        </div>
    </div>

    <script>
        // ★ 時刻は「時間：分」
        setInterval(function () {
            const d = new Date();
            const pad = n => n.toString().padStart(2, '0');

            const dateText = `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())}`;
            const timeText = `${pad(d.getHours())}:${pad(d.getMinutes())}`;

            const dispDate = document.getElementById('dispDate');
            const clock = document.getElementById('clock');
            if (dispDate) dispDate.textContent = dateText;
            if (clock) clock.textContent = timeText;
        }, 1000);

        const autoSelected = @((autoSelected) ? "true" : "false");
        const preloaded = @Html.Raw(preloadedJson);
        const selected = @Html.Raw(selectedJson);

        const branchDisplay = document.getElementById('branchDisplay');

        const divisionSelect = document.getElementById('divisionSelect');
        const startSelect = document.getElementById('startSelect');

        const evCode = document.getElementById('evCode');
        const evName = document.getElementById('evName');
        const evYear = document.getElementById('evYear');
        const evLoc = document.getElementById('evLoc');
        const evRecept = document.getElementById('evRecept');
        const evStart = document.getElementById('evStart');
        const evEnd = document.getElementById('evEnd');

        const btnIn = document.getElementById('btnBatchIn');
        const btnOut = document.getElementById('btnBatchOut');
        const btnTempIn = document.getElementById('btnTempIn');
        const btnTempOut = document.getElementById('btnTempOut');

        function clearDetail() {
            evCode.textContent = "";
            evName.textContent = "";
            evYear.textContent = "";
            evLoc.textContent = "";
            evRecept.textContent = "";
            evStart.textContent = "";
            evEnd.textContent = "";
            btnIn.disabled = true;
            btnOut.disabled = true;
            btnTempIn.disabled = true;
            btnTempOut.disabled = true;
        }

        function setDetail(d) {
            if (!d) return;

            branchDisplay.textContent = (d.branchCd ? d.branchCd : "") + (d.branchName ? " " + d.branchName : "");

            evCode.textContent = d.eventCode ?? "－";
            evName.textContent = d.eventName ?? "－";
            evYear.textContent = d.fiscalYear ?? "－";
            evLoc.textContent = d.location ?? "－";
            evRecept.textContent = d.receptTime ?? "－";
            evStart.textContent = d.startTime ?? "－";
            evEnd.textContent = d.endTime ?? "－";

            btnIn.disabled = false;
            btnOut.disabled = false;
            btnTempIn.disabled = false;
            btnTempOut.disabled = false;
        }

        async function decide(divisionCode, startTime) {
            clearDetail();
            const fd = new FormData();
            fd.append("divisionCode", divisionCode);
            fd.append("startTime", startTime);

            const res = await fetch("/EventSelection/Decide", { method: "POST", body: fd });
            if (!res.ok) {
                alert("イベント確定に失敗しました。");
                return;
            }
            const info = await res.json();
            setDetail(info);
        }

        function setSelectOptions(selectEl, options, placeholder = "選択してください") {
            selectEl.innerHTML = "";
            const ph = document.createElement('option');
            ph.value = "";
            ph.textContent = placeholder;
            selectEl.appendChild(ph);

            options.forEach(o => {
                const opt = document.createElement('option');
                opt.value = o.value;
                opt.textContent = o.text;
                selectEl.appendChild(opt);
            });
        }

        function initAutoSelected() {
            // selected から固定表示（選択不可にする）
            if (selected) {
                setDetail(selected);

                const divText = (selected.eventCode ?? "") + " " + (selected.eventName ?? "");
                setSelectOptions(divisionSelect, [{ value: selected.eventCode ?? "", text: divText }], " ");
                divisionSelect.value = selected.eventCode ?? "";
                divisionSelect.disabled = true;

                setSelectOptions(startSelect, [{ value: selected.startTime ?? "", text: selected.startTime ?? "" }], " ");
                startSelect.value = selected.startTime ?? "";
                startSelect.disabled = true;
            }
        }

        function initMulti() {
            clearDetail();

            // 支店表示（先頭データから）
            if (preloaded.length > 0) {
                const d0 = preloaded[0];
                branchDisplay.textContent = (d0.branchCd ? d0.branchCd : "") + (d0.branchName ? " " + d0.branchName : "");
            }

            // 区分ユニーク
            const divMap = new Map();
            preloaded.forEach(e => {
                if (!divMap.has(e.eventCd)) divMap.set(e.eventCd, e.eventName ?? "");
            });
            const divs = Array.from(divMap.entries())
                .map(x => ({ value: x[0], text: `${x[0]} ${x[1]}` }))
                .sort((a, b) => (a.value > b.value ? 1 : -1));

            setSelectOptions(divisionSelect, divs);

            // 開始時刻候補の再構築
            function rebuildStartTimes(divCode) {
                clearDetail();
                setSelectOptions(startSelect, []);

                if (!divCode) return;

                const candidates = preloaded.filter(e => e.eventCd === divCode);
                const timeMap = new Map();
                candidates.forEach(e => {
                    if (!timeMap.has(e.startTimeRaw)) timeMap.set(e.startTimeRaw, e.startTime);
                });

                const times = Array.from(timeMap.entries())
                    .map(x => ({ raw: x[0], disp: x[1] }))
                    .sort((a, b) => (a.raw > b.raw ? 1 : -1));

                const opts = times.map(t => ({ value: t.disp, text: t.disp }));
                setSelectOptions(startSelect, opts);

                // 1件しかなければ自動確定（selectは枠内のまま、disabledに）
                if (opts.length === 1) {
                    startSelect.value = opts[0].value;
                    startSelect.disabled = true;
                    decide(divCode, opts[0].value);
                } else {
                    startSelect.disabled = false;
                }
            }

            divisionSelect.addEventListener('change', () => {
                startSelect.disabled = false;
                rebuildStartTimes(divisionSelect.value);
            });

            startSelect.addEventListener('change', () => {
                const divCode = divisionSelect.value;
                const st = startSelect.value;
                if (!divCode || !st) return;
                decide(divCode, st);
            });

            // 区分が1件しかなければ自動選択（selectは枠内のまま、disabledに）
            if (divs.length === 1) {
                divisionSelect.value = divs[0].value;
                divisionSelect.disabled = true;
                rebuildStartTimes(divs[0].value);
            } else {
                divisionSelect.disabled = false;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (autoSelected) {
                initAutoSelected();
            } else {
                initMulti();
            }
        });
    </script>
</body>
</html>